<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="UTF-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <script src="/code/jquery-3.6.0.js"></script>
   <link rel="stylesheet" href="/css/shared/button.css" />
   <link rel="stylesheet" href="/css/shared/content4_style.css" />
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet"
      integrity="sha384-wEmeIV1mKuiNpC+IOBjI7aAzPcEZeedi5yW5f2yOq55WWLwNGmvvx4Um1vskeMj0" crossorigin="anonymous">
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-p34f1UUtsS3wqzfto5wAAmdvj+osOnFyQFpp4Ua3gs/ZVWx6oOypYoCJhGGScy+8"
      crossorigin="anonymous"></script>
   <link rel="stylesheet" href="//apps.bdimg.com/libs/jqueryui/1.10.4/css/jquery-ui.min.css">
   <script src="/code/bootstrap-5.2.0-beta1-dist/css/bootstrap.css"></script>
   <script src="/code/bootstrap-5.2.0-beta1-dist/js/bootstrap.bundle.min.js"></script>
   <script src="//apps.bdimg.com/libs/jquery/1.10.2/jquery.min.js"></script>
   <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
   <link rel="stylesheet" href="style.css">

   <title>Orderpage</title>

</head>

<body>
   <div class="grid-container">
      <div>
         <label for=""><b>今日餐廳：</b></label>&nbsp;&nbsp;
         <h3 type="text" disabled="none" class="inputSize" id="TodayRestaurantName">
      </div>
      <div>
         <button type="button" class="function" data-bs-toggle="modal" data-bs-target="#orderSearchModal">訂單紀錄</button>
      </div>
   </div>

   <!-- 左邊DIV1菜單區 -->
   <div id="DIV1">
      <p style="margin-left:20px;"><b>菜單區：</b></p>
      <div class="menusDiv">
         <div id="menus" class="container"></div>
      </div>
      <!-- 左方DIV1下單btn -->
      <br>
      <div>
         <button type="button" id="addcart" class="btnStyle">加入右方購物車</button>
      </div>
   </div>

   <!-- 右邊DIV2下單區 -->
   <div id="DIV2">
      <p style="margin-left:20px;"><b>購物車下單區：</b></p>
      <div class="item_header">
         <div class="item_detail">商品</div>
         <div class="price">單價</div>
         <div class="count">數量</div>
         <div class="amount">總計</div>
         <div class="operate">操作</div>
      </div>
      <div id="app">
         <div class="container">

            <div id="orderCar" class="item_container" v-for="(item, index) in itemList" :key="dish.dishIid">
               <!-- 購物車的東西長在這裡面 -->
            </div>
         </div>
      </div>
      <br>

      <div id="submit2">
         <b><span id="pay_amount">合計：</span><span id="price-num">$$$</span></b>
         <button class="btnStyle btnright">我要下單</button>
         <!-- <dialog class="inforesult" title="請確認購物車數量唷！">
            <dialog class="dialog1">謝謝訂購！</dialog> -->

      </div>
   </div>

   <!-- 訂單紀錄 Modal -->
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bＦootstrap.min.js"
      integrity="sha384-lpyLfhYuitXl2zRZ5Bn2fqnhNAKOAaM/0Kr9laMspuaMiZfGmfwRNFh8HlMy49eQ"
      crossorigin="anonymous"></script>
   <div class="modal fade" id="orderSearchModal" tabindex="-1" aria-labelledby="orderSearchModalLabel"
      aria-hidden="true">
      <div class="modal-dialog" style="width: 380px;">
         <div class="modal-content">
            <div class="modal-header">
               <h5 class="modal-title" id="orderSearchModalLabel">訂單查詢</h5>
               <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body orderSearchDiv">
               <div>
                  <label><b>日期：</b></label>&nbsp;&nbsp;
                  <input type="date" class="inputSize" style="width: 130px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                  <input type="submit" value="查詢" class="btnStyle">
               </div>
               <br>
               <div class="orderRespond">
                  <div>
                     <h6><b>餐廳：</b></h6>
                  </div>
                  <div class="respondDiv">
                     <table class="myfoodTable">
                        <tr class="myfoodBorder">
                           <td class="foodL">
                              <div>牛肉漢堡</div>
                              <div>備註</div>
                           </td>
                           <td class="foodR">
                              <div>NT</div>
                              <div>數量</div>
                           </td>
                        </tr>
                     </table>
                     <br><br><br><br><br><br><br><br><br><br>
                  </div>
                  <div>
                     <label><b>小計：NT $$$</b></label>
                  </div>

               </div>
            </div>
         </div>
      </div>
   </div>

	<script src="/js/punch/moment.min.js"></script>
   <script>
      $(document).ready(getOrdersInCar());
      function getCookie() {
         var cookie = document.cookie.split('=');
         return cookie[1].toString();
      }

      function adder(a) {
         var tmp = document.getElementById(`dish_qty${a}`).innerHTML;
         tmp++;
         document.getElementById(`dish_qty${a}`).innerHTML = tmp;
      }
      function minuser(a) {
         var tmp = document.getElementById(`dish_qty${a}`).innerHTML;
         tmp = tmp - 1;
         if (tmp < 0) { tmp = 0 }
         document.getElementById(`dish_qty${a}`).innerHTML = tmp;
      }
      function addcart() {
         var jsonObj = [];
         var tempPrdList = [];
         for (i = 1; i < 4; i++) {    //數字要改成菜單的數量
            var allcounter = document.getElementById(`dish_qty${i}`).innerHTML;
            if (allcounter != 0) {
               tempPrdList.push(allcounter)
            }
         }
         for (i = 0, j = tempPrdList.length; i < j; i++) {
            var obj = new Object;
            obj.dishId = tempPrdList[i];  //key=id   //待處理：資料無法回傳完整
            jsonObj.push(obj);
         }
         console.log(JSON.stringify(jsonObj));
      }


      var menu, dishData, param;
      var date = new Date();
      window.onload = function () {
         // 判斷時間 下午2點到隔天11點前 結果1:顯示菜單
         if (date.getHours() <= 11 || date.getHours() >= 14) {
            if (date.getHours <= 11) {
               param = JSON.stringify({ "setDate": moment().format('YYYY-MM-DD') });
            } else {
               param = JSON.stringify({ "setDate": moment().add(1,'days').format('YYYY-MM-DD') });
            }
            $.ajax({
               type: "POST",
               url: "/orderSys/getMenu",
               data: param,
               contentType: 'application/json',
               success: function (testData) {
                  $("#TodayRestaurantName").html(oestData[0].restaurantName);

                  var left_menu = document.getElementById("menus");
                  dishData = testData;
                  for (var i = 1; i < testData.length; i++) {

                     menu = document.createElement("div");
                     menu.setAttribute("class", "menu")

                     menu.innerHTML += `<img src="${testData[i].dishPhoto}" width="110" height="110" alt="${testData[i].dishItem}" title="${testData[i].dishItem}" class="pic row" />`
                     menu.innerHTML += `<div class="row">`;
                     menu.innerHTML += `<input id="dish_minus${testData[i].dishId}" type="button" onclick="minuser(${testData[i].dishId})"" value=" - " style="font-size: 20px;" />`;
                     menu.innerHTML += `<type id="dish_qty${testData[i].dishId}" style="font-size: 15px; margin-left: 15px;margin-right: 15px;">0</type>`;
                     menu.innerHTML += `<input id="dish_add${testData[i].dishId}" type="button" onclick="adder(${testData[i].dishId})" value=" + " style="font-size: 19px;" /></div>`;
                     menu.innerHTML += `<p class="row" style="margin-top: 0px; font-size:15px; margin-left: 15px;">${testData[i].dishItem}</p>`;
                     menu.innerHTML += `<p class="row" style=" margin-top: -15px;font-size:15px; margin-left: 15px;">$${testData[i].dishPrice}</p>`;
                     left_menu.appendChild(menu);
                  }
               }
            });
            //時間判斷 結果2
         } else {
            //顯示尚未上架 敬請期待
            alert("商品尚未上架 敬請期待");
         }
      };

      $("#addcart").click(function () {
         var tempData = [];
         for (i = 0; i < data.length; i++) {
            var dish_qty = document.getElementById(`dish_qty${data[i].dishId}`);
            if (dish_qty.innerHTML != "0") {
               console.log(data[i].dishItem + "的數量為：" + dish_qty.innerHTML);
               tempData.push(JSON.parse(`{"dishId" : ${data[i].dishId} ,"qty" : ${dish_qty.innerHTML}}`));
            }
         }
         tempData.splice(0, 0, { userToken: getCookie() });
         var sendData = JSON.stringify(tempData);
         $.ajax({
            type: "post",
            url: "/orderSys/saveToDb",
            data: sendData,
            contentType: 'application/json',
            success: function () {
               //更新右方購物出畫面
               getOrdersInCar();
            }
         });
      })

      function getOrdersInCar() {
         console.log("開始查詢購物車資訊");
         var tokenAndDate = JSON.stringify({
            "userToken": getCookie(),
            "startDate": "2022-06-15 12:00:00",
            "endDate": "2022-06-16 12:00:00"
         });
         $.ajax({
            type: "post",
            url: "/orderSys/getOrder",
            data: tokenAndDate,
            contentType: 'application/json',
            success: function (orderData) {
               updateCarContent(orderData);
            }
         });
      }
      function updateCarContent(orderData){
         var orderRows;
               var carDiv = document.getElementById("orderCar");
               $('#orderCar').empty();
               for (var i = 0; i < orderData.length; i++) {
                  orderRows = document.createElement("table");
                  orderRows.setAttribute("class", "orderRows");
                  orderRows.innerHTML = `<tr class = "" id="${i}" style="border-bottom:1px solid gray " >
                                                <td class = "" id="orderId${i}" width="150px" value="${orderData[i].orderId}">${orderData[i].dishItem}</td>
                                                <td class = "" id="" width="20%">${orderData[i].dishPrice}</td>
                                                <td class = "" id="" width="20%">${orderData[i].qty}</td> 
                                                <td class = "" id="" width="20%">${orderData[i].qty * orderData[i].dishPrice}</td>
                                                <td class = "" id="" width="15%"><button onClick="deleteOrder(${i})">刪除</button></td>
                                          </tr>`;

                  carDiv.appendChild(orderRows);
               }

      }


     function deleteOrder(id){
      var orderId = document.getElementById(`orderId${id}`).getAttribute('value');
      var targetData = JSON.stringify({ orderId : orderId});
      $.ajax({
         type : "delete",
         url : "/orderSys/deleteOrderInCar",
         data : targetData, 
         contentType : 'application/json',
         success : function(){
            getOrdersInCar();
            alert("刪除成功");
         }
      });
     }

      


      //商品選取框
      var check = oDiv.firstChild.getElementsByTagName("i")[0];
      check.onclick = function () {
         // console.log(check.className);
         if (check.className == "i_check i_acity") {
            check.classList.remove("i_acity");

         } else {
            check.classList.add("i_acity");
         }
         getAmount();
      }

      //進行價格計算
      function getAmount() {
         //獲取選取的選擇框
         ns = document.getElementsByClassName("i_acity");
         //初始化總價
         sum = 0;
         //選取框
         document.getElementById("price_num").innerText = sum;
         for (y = 0; y < ns.length; y++) {
            //小計
            amount_info = ns[y].parentElement.parentElement.lastElementChild.previousElementSibling;
            num = parseInt(amount_info.innerText);
            sum += num;
            document.getElementById("price_num").innerText = sum;
         }
      }

   </script>


</body>

</html>